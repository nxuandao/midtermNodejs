<div class="page-inner">
  <div class="page-header">
    <h3 class="fw-bold mb-3">DANH SÁCH</h3>
    <ul class="breadcrumbs mb-3">
      <li class="nav-home">
        <a href="/"><i class="icon-home"></i></a>
      </li>
      <li class="separator"><i class="icon-arrow-right"></i></li>
      <li class="nav-item"><a href="/products">Danh sách sản phẩm</a></li>
    </ul>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex align-items-center">
            <h4 class="card-title">Danh Sách Sản Phẩm</h4>
            <button class="btn btn-primary btn-round ms-auto" 
              data-bs-toggle="modal" data-bs-target="#addProductModal">
              <i class="fa fa-plus"></i> Thêm Sản Phẩm
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table id="product-table" class="display table table-striped table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Tên Sản Phẩm</th>
                  <th>Giá Bán</th>
                  <th>Mô tả</th>
                  <th>Loại</th>
                  <th>Thao Tác</th>
                </tr>
              </thead>
              <tfoot>
                <tr>
                  <th>ID</th>
                  <th>Tên Sản Phẩm</th>
                  <th>Giá Bán</th>
                  <th>Mô tả</th>
                  <th>Loại</th>
                  <th>Thao Tác</th>
                </tr>
              </tfoot>
              <tbody>
                {{#each products}}
                <tr>
                  <td>{{this.id}}</td>
                  <td>{{this.ten}}</td>
                  <td>{{this.gia}}</td>
                  <td>{{this.mota}}</td>
                  <td>{{this.category_id}}</td>
                  <td>
                    <div class="form-button-action">
                      <button class="btn btn-link btn-primary btn-edit" data-id="{{this.id}}" 
                        data-bs-toggle="tooltip" title="Sửa Sản Phẩm">
                        <i class="fa fa-edit"></i>
                      </button>
                      <button class="btn btn-link btn-danger btn-delete" data-id="{{this.id}}" 
                        data-bs-toggle="tooltip" title="Xóa Sản Phẩm">
                        <i class="fa fa-times"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {{else}}
                <tr>
                  <td colspan="6" class="text-center">Không có sản phẩm nào.</td>
                </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Thêm Sản Phẩm -->
<div class="modal fade" id="addProductModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <span class="fw-mediumbold">Thêm Mới</span>
          <span class="fw-light">Sản Phẩm</span>
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
            <div class="form-group">
                <label>Tên Sản Phẩm</label>
                <input type="text" id="ten" class="form-control" placeholder="Nhập tên sản phẩm" />
            </div>
            <div class="form-group">
                <label>Giá Bán</label>
                <input type="number" id="gia" class="form-control" placeholder="Nhập giá bán" />
            </div>
            <div class="form-group">
                <label>Mô tả</label>
                <input type="text" id="mota" class="form-control" placeholder="Nhập mô tả sản phẩm" />
            </div>
            <div class="form-group">
                <label for="loai">Loại sản phẩm</label>
                <select id="loai" class="form-control">
                    <option value="" disabled selected>Chọn loại sản phẩm</option>
                    {{#each categories}}
                    <option value="{{this.id}}">{{this.ten}}</option>
                    {{/each}}
                </select>
            </div>  
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-primary" id="addProductButton">Thêm</button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Sửa Sản Phẩm -->
<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title">
          <span class="fw-mediumbold">Sửa</span>
          <span class="fw-light">Sản Phẩm</span>
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label>Tên Sản Phẩm</label>
            <input type="text" id="editTen" class="form-control" placeholder="Nhập tên sản phẩm" />
          </div>
          <div class="form-group">
            <label>Giá Bán</label>
            <input type="number" id="editGia" class="form-control" placeholder="Nhập giá bán" />
          </div>
          <div class="form-group">
            <label>Mô tả</label>
            <input type="text" id="editMota" class="form-control" placeholder="Nhập mô tả sản phẩm" />
          </div>
          <div class="form-group">
            <label for="editLoai">Loại sản phẩm</label>
            <select id="editLoai" class="form-control">
              <option value="" disabled selected>Chọn loại sản phẩm</option>
              {{#each categories}}
              <option value="{{this.id}}">{{this.ten}}</option>
              {{/each}}
            </select>
          </div>  
        </form>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-primary" id="editProductButton">Cập nhật</button>
        <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Xóa Sản Phẩm -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title text-danger">
          <span class="fw-mediumbold">Xóa</span>
          <span class="fw-light">Sản Phẩm</span>
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc chắn muốn xóa sản phẩm này không?</p>
        <p class="text-muted">Hành động này không thể hoàn tác.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Xóa</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
      </div>
    </div>
  </div>
</div>

<!-- JS Dependencies -->
<script src="js/core/jquery-3.7.1.min.js"></script>
<script src="js/core/popper.min.js"></script>
<script src="js/core/bootstrap.min.js"></script>
<script src="js/plugin/datatables/datatables.min.js"></script>

<script>
  $(document).ready(function () {
    // Khởi tạo DataTable
    $('#product-table').DataTable({
      pageLength: 5,
      initComplete: function () {
        this.api()
          .columns()
          .every(function () {
            var column = this;
            var select = $('<select class="form-select"><option value=""></option></select>')
              .appendTo($(column.footer()).empty())
              .on('change', function () {
                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                column.search(val ? '^' + val + '$' : '', true, false).draw();
              });
            column.data().unique().sort().each(function (d) {
              select.append(`<option value="${d}">${d}</option>`);
            });
          });
      },
    });

        // Xử lý thêm sản phẩm
      $('#addProductButton').click(function () {
          const tenSanPham = $('#ten').val();
          const loaiSanPham = $('#loai').val();
          const giaBan = $('#gia').val();
          const mota = $('#mota').val();

          // Kiểm tra xem người dùng đã điền đủ thông tin chưa
          if (!tenSanPham || !giaBan || !mota || !loaiSanPham) {
              alert('Vui lòng điền đủ thông tin');
              return;
          }

          // Gửi yêu cầu POST đến backend để thêm sản phẩm
          fetch('/products/add', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                  ten: tenSanPham,
                  gia: giaBan,
                  mota: mota,
                  loai: loaiSanPham
              })
          })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Lỗi khi thêm sản phẩm');
              }
              return response.json();
          })
          .then(data => {
              // Hiển thị thông báo thành công
              if (data.message) {
                  alert(data.message);
                  location.reload(); 
              } else {
                  alert('Lỗi khi thêm sản phẩm');
              }
          })
          .catch(async (error) => {
              console.error('Lỗi:', error);
              alert('Có lỗi xảy ra');
          });
      });
      // Sự kiện khi nhấn nút Sửa
    $('#product-table').on('click', '.btn-edit', function () {
      const productId = $(this).data('id');
      const row = $(this).closest('tr');
      const ten = row.find('td').eq(1).text();
      const gia = row.find('td').eq(2).text();
      const mota = row.find('td').eq(3).text();
      const loai = row.find('td').eq(4).text();

      $('#editProductModal #editTen').val(ten);
      $('#editProductModal #editGia').val(gia);
      $('#editProductModal #editMota').val(mota);
      $('#editProductModal #editLoai').val(loai);
      $('#editProductModal').modal('show');

      // Xử lý cập nhật sản phẩm
      $('#editProductButton').off('click').on('click', function () {
        fetch(`/products/${productId}/edit`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ten: $('#editTen').val(),
            gia: $('#editGia').val(),
            mota: $('#editMota').val(),
            loai: $('#editLoai').val()
          })
        })
        .then(response => {
          if (!response.ok) throw new Error('Lỗi khi cập nhật sản phẩm');
          return response.json();
        })
        .then(data => {
          location.reload();
        })
        .catch(error => {
          console.error('Lỗi:', error);
          alert('Có lỗi xảy ra');
        });
      });
    });

    // Sự kiện khi nhấn nút Xóa
    $('#product-table').on('click', '.btn-delete', function () {
      const productId = $(this).data('id');
      $('#deleteProductModal').modal('show');

      $('#confirmDeleteButton').off('click').on('click', function () {
        fetch(`/products/${productId}`, {
          method: 'DELETE',
        })
        .then(response => {
          if (!response.ok) throw new Error('Lỗi khi xóa sản phẩm');
          return response.json();
        })
        .then(data => {
          location.reload();
        })
        .catch(error => {
          console.error('Lỗi:', error);
          alert('Có lỗi xảy ra');
        });
      });
    });
  });
</script>
